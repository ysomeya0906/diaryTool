<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daily Growth Journal</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <!-- Header -->
    <header>
        <h1>Daily Growth</h1>
    </header>

    <!-- Main Content Area -->
    <main id="main-content">

        <!-- SECTION: INPUT -->
        <section id="tab-input" class="active-tab">
            <div class="card date-card">
                <input type="date" id="date-picker">
            </div>

            <div id="yesterday-plan-container" class="card highlight-card" style="display: none;">
                <h3><i class="fas fa-history"></i> 昨日の「明日の予定」</h3>
                <p id="yesterday-plan-text">Loading...</p>
            </div>

            <form id="diary-form">
                <div class="input-group">
                    <label>1. 経験したこと</label>
                    <textarea id="inp-experience" placeholder="今日あった出来事は？"></textarea>
                </div>
                <div class="input-group">
                    <label>2. 感じたこと・気づいたこと</label>
                    <textarea id="inp-feelings" placeholder="どう感じましたか？"></textarea>
                </div>
                <div class="input-group">
                    <label>3. 新しいアイデア</label>
                    <textarea id="inp-ideas" placeholder="思いついたことは？"></textarea>
                </div>
                <div class="input-group">
                    <label>4. 明日の予定</label>
                    <textarea id="inp-tomorrow" placeholder="明日は何をする？"></textarea>
                </div>

                <button type="submit" id="save-btn" class="primary-btn">
                    <i class="fas fa-paper-plane"></i> 記録する
                </button>
            </form>
        </section>

        <!-- SECTION: HISTORY -->
        <section id="tab-history">
            <h2>History</h2>
            <div id="history-list">
                <!-- Entries will be injected here -->
            </div>
        </section>

        <!-- SECTION: ANALYSIS (Future expansion) -->
        <section id="tab-analysis">
            <h2>Analysis</h2>
            <p style="text-align:center; color:#888;">Coming Soon: Growth Charts</p>
        </section>

    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('input')">
            <i class="fas fa-pen"></i>
            <span>Input</span>
        </button>
        <button class="nav-btn" onclick="switchTab('history')">
            <i class="fas fa-book"></i>
            <span>History</span>
        </button>
        <button class="nav-btn" onclick="switchTab('analysis')">
            <i class="fas fa-chart-line"></i>
            <span>Analysis</span>
        </button>
    </nav>

    <script>
        // --- Init ---
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date-picker').value = today;

        // --- Functions ---
        function switchTab(tabName) {
            // Hide all sections
            document.querySelectorAll('main section').forEach(el => el.classList.remove('active-tab'));
            // Remove active class from navs
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));

            // Show target
            document.getElementById(`tab-${tabName}`).classList.add('active-tab');
            // Highlight nav - finding index basics
            const mapping = { 'input': 0, 'history': 1, 'analysis': 2 };
            document.querySelectorAll('.nav-btn')[mapping[tabName]].classList.add('active');

            if (tabName === 'history') loadHistory();
        }

        async function loadYesterdayPlan() {
            const date = document.getElementById('date-picker').value;
            const res = await fetch(`/api/yesterday_plan?date=${date}`);
            const data = await res.json();

            const box = document.getElementById('yesterday-plan-container');
            if (data.plan) {
                document.getElementById('yesterday-plan-text').textContent = data.plan;
                box.style.display = 'block';
            } else {
                box.style.display = 'none';
            }
        }

        async function loadHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '<p>Loading...</p>';

            try {
                const res = await fetch('/api/history');
                const entries = await res.json();

                list.innerHTML = '';
                if (entries.length === 0) {
                    list.innerHTML = '<p>No entries yet.</p>';
                    return;
                }

                entries.forEach(entry => {
                    const card = document.createElement('div');
                    card.className = 'card entry-card';
                    card.innerHTML = `
                        <div class="entry-header">
                            <span class="entry-date">${entry.Date}</span>
                            <span class="entry-time">${entry.Timestamp ? entry.Timestamp.split(' ')[1].slice(0, 5) : ''}</span>
                        </div>
                        <div class="entry-body">
                            <p><strong>Exp:</strong> ${entry.Experience ? entry.Experience.substring(0, 50) + '...' : ''}</p>
                            <p><strong>Plan:</strong> ${entry.TomorrowPlan || ''}</p>
                        </div>
                    `;
                    list.appendChild(card);
                });
            } catch (e) {
                list.innerHTML = '<p>Error loading history.</p>';
            }
        }

        // --- Event Listeners ---
        document.getElementById('date-picker').addEventListener('change', loadYesterdayPlan);

        document.getElementById('diary-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const btn = document.getElementById('save-btn');

            btn.disabled = true;
            btn.innerText = " Saving...";

            const payload = {
                date: document.getElementById('date-picker').value,
                experience: document.getElementById('inp-experience').value,
                feelings: document.getElementById('inp-feelings').value,
                ideas: document.getElementById('inp-ideas').value,
                tomorrow_plan: document.getElementById('inp-tomorrow').value
            };

            try {
                const res = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.status === 'success') {
                    alert('記録しました！');
                    // Reset form or stay? User preference unknown so keep form for now.

                    // If we were automatically switching tabs, we'd do it here, but usually "Record" stays on input.
                    // Just updating History function if needed.
                } else {
                    alert('Error saving: ' + (data.message || 'Unknown error'));
                }
            } catch (err) {
                console.error(err);
                alert('An error occurred: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> 記録する';
            }
        });

        // Run on load
        loadYesterdayPlan();
    </script>
</body>

</html>